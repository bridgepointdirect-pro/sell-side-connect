import React, { useState, useEffect } from 'react';
import { Trash2 } from 'lucide-react';

export default function ExpenseTracker() {
  const [person1Name, setPerson1Name] = useState('');
  const [person2Name, setPerson2Name] = useState('');
  const [expenses, setExpenses] = useState([]);
  const [amount, setAmount] = useState('');
  const [description, setDescription] = useState('');
  const [paidBy, setPaidBy] = useState('person1');
  const [namesSet, setNamesSet] = useState(false);
  const [loading, setLoading] = useState(true);

  // Load data from shared storage
  useEffect(() => {
    const loadData = async () => {
      try {
        const namesResult = await window.storage.get('expense-names', true);
        if (namesResult) {
          const names = JSON.parse(namesResult.value);
          setPerson1Name(names.person1);
          setPerson2Name(names.person2);
          setNamesSet(true);
        }

        const expensesResult = await window.storage.get('expense-list', true);
        if (expensesResult) {
          setExpenses(JSON.parse(expensesResult.value));
        }
      } catch (error) {
        console.log('No saved data found');
      }
      setLoading(false);
    };
    loadData();
  }, []);

  const saveNames = async () => {
    if (person1Name.trim() && person2Name.trim()) {
      await window.storage.set('expense-names', JSON.stringify({
        person1: person1Name,
        person2: person2Name
      }), true);
      setNamesSet(true);
    }
  };

  const saveExpenses = async (newExpenses) => {
    await window.storage.set('expense-list', JSON.stringify(newExpenses), true);
  };

  const addExpense = async () => {
    if (amount && parseFloat(amount) > 0) {
      const newExpense = {
        id: Date.now(),
        amount: parseFloat(amount),
        description: description || 'Expense',
        paidBy,
        date: new Date().toLocaleDateString()
      };
      const newExpenses = [...expenses, newExpense];
      setExpenses(newExpenses);
      await saveExpenses(newExpenses);
      setAmount('');
      setDescription('');
    }
  };

  const deleteExpense = async (id) => {
    const newExpenses = expenses.filter(exp => exp.id !== id);
    setExpenses(newExpenses);
    await saveExpenses(newExpenses);
  };

  const calculateBalance = () => {
    let balance = 0;
    expenses.forEach(exp => {
      if (exp.paidBy === 'person1') {
        balance += exp.amount;
      } else {
        balance -= exp.amount;
      }
    });
    return balance;
  };

  const resetAll = async () => {
    if (window.confirm('Are you sure you want to reset everything? This will affect both users.')) {
      try {
        await window.storage.delete('expense-names', true);
        await window.storage.delete('expense-list', true);
      } catch (error) {
        console.log('Error deleting data');
      }
      setPerson1Name('');
      setPerson2Name('');
      setExpenses([]);
      setNamesSet(false);
    }
  };

  const balance = calculateBalance();

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6 flex items-center justify-center">
        <div className="text-2xl text-gray-600">Loading...</div>
      </div>
    );
  }

  if (!namesSet) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6 flex items-center justify-center">
        <div className="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
          <h1 className="text-3xl font-bold text-gray-800 mb-2 text-center">Who's Tracking?</h1>
          <p className="text-sm text-gray-600 mb-6 text-center">This will be shared with everyone who has this link</p>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Person 1 Name</label>
              <input
                type="text"
                value={person1Name}
                onChange={(e) => setPerson1Name(e.target.value)}
                placeholder="Enter name"
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Person 2 Name</label>
              <input
                type="text"
                value={person2Name}
                onChange={(e) => setPerson2Name(e.target.value)}
                placeholder="Enter name"
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
            <button
              onClick={saveNames}
              className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
            >
              Start Tracking
            </button>
          </div>
        </div>
      </div>
    );
  }

  const amountLabel = paidBy === 'person1' ? `${person2Name} owes` : `${person1Name} owes`;

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
      <div className="max-w-2xl mx-auto">
        <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold text-gray-800">Expense Tracker</h1>
            <button
              onClick={resetAll}
              className="text-sm text-gray-500 hover:text-red-600 transition"
            >
              Reset All
            </button>
          </div>

          <div className="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl p-6 text-white mb-8">
            <p className="text-sm opacity-90 mb-2">Current Balance</p>
            <div className="text-3xl font-bold">
              {balance === 0 ? (
                <span>All settled up! ðŸŽ‰</span>
              ) : balance > 0 ? (
                <span>{person2Name} owes {person1Name} ${Math.abs(balance).toFixed(2)}</span>
              ) : (
                <span>{person1Name} owes {person2Name} ${Math.abs(balance).toFixed(2)}</span>
              )}
            </div>
          </div>

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Who paid?</label>
              <div className="grid grid-cols-2 gap-3">
                <button
                  onClick={() => setPaidBy('person1')}
                  className={`py-3 rounded-lg font-medium transition ${
                    paidBy === 'person1'
                      ? 'bg-blue-600 text-white'
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  {person1Name}
                </button>
                <button
                  onClick={() => setPaidBy('person2')}
                  className={`py-3 rounded-lg font-medium transition ${
                    paidBy === 'person2'
                      ? 'bg-indigo-600 text-white'
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  {person2Name}
                </button>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">{amountLabel}</label>
              <input
                type="number"
                value={amount}
                onChange={(e) => setAmount(e.target.value)}
                placeholder="0.00"
                step="0.01"
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Description (optional)</label>
              <input
                type="text"
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                placeholder="What was this for?"
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <button
              onClick={addExpense}
              className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition"
            >
              Add Expense
            </button>
          </div>
        </div>

        {expenses.length > 0 && (
          <div className="bg-white rounded-2xl shadow-xl p-8">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Recent Expenses</h2>
            <div className="space-y-3">
              {expenses.slice().reverse().map(exp => (
                <div key={exp.id} className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                  <div className="flex-1">
                    <p className="font-semibold text-gray-800">{exp.description}</p>
                    <p className="text-sm text-gray-600">
                      Paid by {exp.paidBy === 'person1' ? person1Name : person2Name} â€¢ {exp.date}
                    </p>
                  </div>
                  <div className="flex items-center gap-4">
                    <span className="text-lg font-bold text-gray-800">${exp.amount.toFixed(2)}</span>
                    <button
                      onClick={() => deleteExpense(exp.id)}
                      className="text-red-500 hover:text-red-700 transition"
                    >
                      <Trash2 size={18} />
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}